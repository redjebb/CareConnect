rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Проверява дали потребителят е влязъл в системата
    function isAuthenticated() {
      return request.auth != null;
    }

    // Изтегля данните на потребителя от основната колекция
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    // Проверка за конкретни роли
    function isMasterAdmin() {
      return isAuthenticated() && getUserData().role == 'MASTER_ADMIN';
    }

    function isManager() {
      return isAuthenticated() && getUserData().role == 'MANAGER';
    }

    function isDriver() {
      return isAuthenticated() && getUserData().role == 'DRIVER';
    }

    // Проверка за административен достъп (Master или Manager)
    function isAnyAdmin() {
      return isMasterAdmin() || isManager();
    }

    // ----------------------------------------------------
    // 1. USERS (Ядрото на сигурността)
    // ----------------------------------------------------
    match /users/{userId} {
      allow read: if isAuthenticated() && request.auth.uid == userId;
      allow write: if isMasterAdmin(); // Само главният админ раздава роли
    }

    // ----------------------------------------------------
    // 2. CLIENTS (Маршрути за деня)
    // ----------------------------------------------------
    match /clients/{clientId} {
      allow read: if isAuthenticated(); // Шофьорите четат къде да ходят
      allow create, delete: if isAnyAdmin();
      allow update: if isAuthenticated(); // Шофьорите отбелязват доставка
    }

    // ----------------------------------------------------
    // 3. CLIENTS_REGISTRY (Чувствителни данни / ЕГН)
    // ----------------------------------------------------
    match /clients_registry/{clientId} {
      // Само админи имат достъп до пълния регистър
      allow read, write: if isAnyAdmin();
    }

    // ----------------------------------------------------
    // 4. DRIVERS (Профили на шофьорите)
    // ----------------------------------------------------
    match /drivers/{driverId} {
      allow read: if isAuthenticated();
      allow create, delete: if isAnyAdmin();
      // Позволяваме на шофьора да обновява своя статус/локация
      allow update: if isAuthenticated();
    }

    // ----------------------------------------------------
    // 5. SCHEDULE & SHIFTS (Графици и смени)
    // ----------------------------------------------------
    match /schedule/{docId} {
      allow read: if isAuthenticated();
      allow write: if isAnyAdmin();
    }

    match /shifts/{shiftId} {
      // Шофьорите пускат/спират смяна, админите ги контролират
      allow read, write: if isAuthenticated();
    }

    // ----------------------------------------------------
    // 6. INCIDENTS (SOS Сигнали и проблеми)
    // ----------------------------------------------------
    match /incidents/{incidentId} {
      allow create, read: if isAuthenticated();
      allow update, delete: if isAnyAdmin();
    }

    // ----------------------------------------------------
    // 7. DELIVERY_HISTORY (Архив на доставките)
    // ----------------------------------------------------
    match /deliveryHistory/{docId} {
      // Всеки шофьор трябва да може да запише успешното предаване
      allow read, write: if isAuthenticated();
    }

    // ----------------------------------------------------
    // 8. INVITATIONS (Покани за нови служители)
    // ----------------------------------------------------
    match /invitations/{invitationId} {
      // Позволяваме read без Auth, за да се зареди страницата за активация
      allow read: if true; 
      allow update: if true; 
      allow create, delete: if isAnyAdmin();
    }

    // ----------------------------------------------------
    // 9. ADMINS (Старият регистър за съвместимост)
    // ----------------------------------------------------
    match /admins/{adminId} {
      allow read: if isAuthenticated();
      allow write: if isMasterAdmin();
    }
  }
}