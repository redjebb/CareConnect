rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Проверява дали потребителят е влязъл в системата
    function isAuthenticated() {
      return request.auth != null;
    }

    // Проверка за административен достъп (Master или Manager)
    // При Auto-ID най-сигурно е да проверяваме дали имейлът съществува в колекция 'admins'
    function isAnyAdmin() {
      return isAuthenticated() && exists(/databases/$(database)/documents/admins/$(request.auth.token.email));
    }

    // Проверка за Master Admin (Твърдо зададен имейл за най-високо ниво на сигурност)
    function isMasterAdmin() {
      return isAuthenticated() && request.auth.token.email == "redjebtudjar@gmail.com";
    }

    // 1. USERS
    match /users/{userId} {
      allow read: if isAuthenticated() && request.auth.uid == userId;
      allow write: if isMasterAdmin();
    }

    // 2. CLIENTS
    match /clients/{clientId} {
      allow read: if isAuthenticated();
      allow create, delete: if isAnyAdmin();
      allow update: if isAuthenticated();
    }

    // 3. CLIENTS_REGISTRY
    match /clients_registry/{clientId} {
      allow read, write: if isAnyAdmin();
    }

    // 4. DRIVERS
    match /drivers/{driverId} {
      allow read: if isAuthenticated();
      allow create, delete: if isAnyAdmin();
      allow update: if isAuthenticated();
    }

    // 5. SCHEDULE & SHIFTS
    match /schedule/{docId} {
      allow read: if isAuthenticated();
      allow write: if isAnyAdmin();
    }

    match /shifts/{shiftId} {
      allow read, write: if isAuthenticated();
    }

    // 6. INCIDENTS
    match /incidents/{incidentId} {
      allow create, read: if isAuthenticated();
      allow update, delete: if isAnyAdmin();
    }

    // 7. DELIVERY_HISTORY
    match /deliveryHistory/{docId} {
      allow read, write: if isAuthenticated();
    }

    // 8. INVITATIONS
    match /invitations/{invitationId} {
      allow read: if true; 
      allow update: if true; 
      allow create, delete: if isAnyAdmin();
    }

    // 9. ADMINS
    match /admins/{adminId} {
      allow read: if isAuthenticated();
      allow write: if isMasterAdmin();
    }
  }
}